#!/usr/bin/env python3
"""
Vulnerability Dashboard
Dashboard interativo para monitoramento de vulnerabilidades.
"""

import json
from datetime import datetime, timedelta
from dataclasses import dataclass, asdict
from typing import List, Dict, Optional
from collections import defaultdict
import random

from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from rich.layout import Layout
from rich.live import Live
import matplotlib.pyplot as plt
import pandas as pd

console = Console()


@dataclass
class Vulnerability:
    """Representa uma vulnerabilidade."""
    id: str
    name: str
    severity: str
    category: str
    url: str
    detected_at: str
    status: str = "open"
    fixed_at: Optional[str] = None


class VulnerabilityStore:
    """Armazenamento de vulnerabilidades."""
    
    def __init__(self):
        self.vulnerabilities: List[Vulnerability] = []
    
    def add(self, vuln: Vulnerability):
        self.vulnerabilities.append(vuln)
    
    def get_by_severity(self, severity: str) -> List[Vulnerability]:
        return [v for v in self.vulnerabilities if v.severity == severity]
    
    def get_by_status(self, status: str) -> List[Vulnerability]:
        return [v for v in self.vulnerabilities if v.status == status]
    
    def get_summary(self) -> Dict:
        summary = {"high": 0, "medium": 0, "low": 0, "info": 0}
        for vuln in self.vulnerabilities:
            if vuln.severity.lower() in summary:
                summary[vuln.severity.lower()] += 1
        return summary
    
    def get_trend_data(self, days: int = 30) -> Dict[str, List]:
        """Dados de tend√™ncia para gr√°ficos."""
        trend = defaultdict(lambda: {"high": 0, "medium": 0, "low": 0})
        
        for vuln in self.vulnerabilities:
            date = vuln.detected_at[:10]
            severity = vuln.severity.lower()
            if severity in trend[date]:
                trend[date][severity] += 1
        
        return dict(trend)


class Dashboard:
    """Dashboard de visualiza√ß√£o."""
    
    def __init__(self, store: VulnerabilityStore):
        self.store = store
    
    def render_summary_table(self) -> Table:
        """Tabela de resumo."""
        summary = self.store.get_summary()
        total = sum(summary.values())
        
        table = Table(title="üõ°Ô∏è Resumo de Vulnerabilidades")
        table.add_column("Severidade", style="bold")
        table.add_column("Quantidade", justify="right")
        table.add_column("Percentual", justify="right")
        table.add_column("Status")
        
        table.add_row(
            "üî¥ High",
            str(summary["high"]),
            f"{summary['high']/total*100:.1f}%" if total > 0 else "0%",
            "‚ñà" * min(summary["high"], 20)
        )
        table.add_row(
            "üü† Medium",
            str(summary["medium"]),
            f"{summary['medium']/total*100:.1f}%" if total > 0 else "0%",
            "‚ñà" * min(summary["medium"], 20)
        )
        table.add_row(
            "üü° Low",
            str(summary["low"]),
            f"{summary['low']/total*100:.1f}%" if total > 0 else "0%",
            "‚ñà" * min(summary["low"], 20)
        )
        table.add_row(
            "üü¢ Info",
            str(summary["info"]),
            f"{summary['info']/total*100:.1f}%" if total > 0 else "0%",
            "‚ñà" * min(summary["info"], 20)
        )
        
        return table
    
    def render_recent_vulns(self, limit: int = 10) -> Table:
        """Tabela de vulnerabilidades recentes."""
        table = Table(title="üìù Vulnerabilidades Recentes")
        table.add_column("ID", style="dim")
        table.add_column("Nome")
        table.add_column("Severidade")
        table.add_column("Categoria")
        table.add_column("Data")
        
        severity_styles = {
            "high": "red",
            "medium": "yellow",
            "low": "cyan",
            "info": "white"
        }
        
        recent = sorted(
            self.store.vulnerabilities,
            key=lambda x: x.detected_at,
            reverse=True
        )[:limit]
        
        for vuln in recent:
            style = severity_styles.get(vuln.severity.lower(), "white")
            table.add_row(
                vuln.id[:8],
                vuln.name[:40],
                f"[{style}]{vuln.severity}[/{style}]",
                vuln.category,
                vuln.detected_at[:10]
            )
        
        return table
    
    def render_category_breakdown(self) -> Table:
        """Breakdown por categoria."""
        categories = defaultdict(int)
        for vuln in self.store.vulnerabilities:
            categories[vuln.category] += 1
        
        table = Table(title="üìä Por Categoria")
        table.add_column("Categoria")
        table.add_column("Total", justify="right")
        
        for cat, count in sorted(categories.items(), key=lambda x: -x[1]):
            table.add_row(cat, str(count))
        
        return table
    
    def generate_chart(self, output_path: str = "trend.png"):
        """Gera gr√°fico de tend√™ncia."""
        trend_data = self.store.get_trend_data()
        
        if not trend_data:
            return
        
        df = pd.DataFrame.from_dict(trend_data, orient="index")
        df.index = pd.to_datetime(df.index)
        df = df.sort_index()
        
        fig, ax = plt.subplots(figsize=(12, 6))
        
        ax.fill_between(df.index, df["high"], alpha=0.3, color="red", label="High")
        ax.fill_between(df.index, df["medium"], alpha=0.3, color="orange", label="Medium")
        ax.fill_between(df.index, df["low"], alpha=0.3, color="yellow", label="Low")
        
        ax.plot(df.index, df["high"], color="red", linewidth=2)
        ax.plot(df.index, df["medium"], color="orange", linewidth=2)
        ax.plot(df.index, df["low"], color="yellow", linewidth=2)
        
        ax.set_xlabel("Data")
        ax.set_ylabel("Vulnerabilidades")
        ax.set_title("Tend√™ncia de Vulnerabilidades")
        ax.legend()
        ax.grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.savefig(output_path, dpi=150)
        console.print(f"[green]‚úÖ Gr√°fico salvo em {output_path}[/green]")
    
    def display(self):
        """Exibe dashboard no terminal."""
        layout = Layout()
        
        layout.split_column(
            Layout(name="header", size=3),
            Layout(name="body"),
            Layout(name="footer", size=3)
        )
        
        layout["body"].split_row(
            Layout(name="left"),
            Layout(name="right")
        )
        
        console.print("\n")
        console.print(Panel("[bold cyan]üõ°Ô∏è Security Vulnerability Dashboard[/bold cyan]", border_style="cyan"))
        console.print("\n")
        console.print(self.render_summary_table())
        console.print("\n")
        console.print(self.render_recent_vulns())
        console.print("\n")
        console.print(self.render_category_breakdown())
    
    def export_json(self, output_path: str):
        """Exporta dados para JSON."""
        data = {
            "summary": self.store.get_summary(),
            "vulnerabilities": [asdict(v) for v in self.store.vulnerabilities],
            "generated_at": datetime.now().isoformat()
        }
        
        with open(output_path, "w") as f:
            json.dump(data, f, indent=2)
        
        console.print(f"[green]‚úÖ Dados exportados para {output_path}[/green]")


def generate_sample_data(store: VulnerabilityStore, count: int = 50):
    """Gera dados de exemplo."""
    categories = ["SQL Injection", "XSS", "CSRF", "Authentication", "Authorization", "Information Disclosure"]
    severities = ["high", "medium", "low", "info"]
    
    for i in range(count):
        days_ago = random.randint(0, 30)
        detected = datetime.now() - timedelta(days=days_ago)
        
        vuln = Vulnerability(
            id=f"VULN-{i+1:04d}",
            name=f"{random.choice(categories)} vulnerability #{i+1}",
            severity=random.choice(severities),
            category=random.choice(categories),
            url=f"https://example.com/path/{i}",
            detected_at=detected.isoformat()
        )
        store.add(vuln)


def main():
    import argparse
    
    parser = argparse.ArgumentParser(description="Vulnerability Dashboard")
    parser.add_argument("--input", "-i", help="Arquivo JSON de entrada")
    parser.add_argument("--output", "-o", help="Arquivo de sa√≠da")
    parser.add_argument("--chart", help="Gerar gr√°fico de tend√™ncia")
    parser.add_argument("--demo", action="store_true", help="Usar dados de demonstra√ß√£o")
    
    args = parser.parse_args()
    
    store = VulnerabilityStore()
    
    if args.demo:
        generate_sample_data(store)
    elif args.input:
        with open(args.input) as f:
            data = json.load(f)
            for v in data.get("vulnerabilities", []):
                store.add(Vulnerability(**v))
    
    dashboard = Dashboard(store)
    dashboard.display()
    
    if args.output:
        dashboard.export_json(args.output)
    
    if args.chart:
        dashboard.generate_chart(args.chart)


if __name__ == "__main__":
    main()
