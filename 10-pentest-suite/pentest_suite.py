#!/usr/bin/env python3
"""
Penetration Testing Suite
Suite completa de pentesting automatizado.
"""

import os
import socket
import argparse
import subprocess
from typing import List, Dict
from dataclasses import dataclass
from concurrent.futures import ThreadPoolExecutor

from rich.console import Console
from rich.table import Table
from rich.progress import Progress

console = Console()

COMMON_PORTS = [
    21, 22, 23, 25, 53, 80, 110, 111, 135, 139, 143, 443, 445, 993, 995,
    1723, 3306, 3389, 5432, 5900, 8080, 8443, 8888, 9090
]

SERVICE_MAP = {
    21: "FTP", 22: "SSH", 23: "Telnet", 25: "SMTP", 53: "DNS",
    80: "HTTP", 110: "POP3", 443: "HTTPS", 445: "SMB", 3306: "MySQL",
    3389: "RDP", 5432: "PostgreSQL", 8080: "HTTP-Proxy"
}


@dataclass
class ScanResult:
    port: int
    state: str
    service: str
    version: str = ""
    vulnerabilities: List[str] = None


class PentestSuite:
    """Suite de penetration testing."""
    
    def __init__(self, target: str):
        self.target = target
        self.results: List[ScanResult] = []
    
    def port_scan(self, port: int, timeout: float = 1.0) -> bool:
        """Verifica se porta estÃ¡ aberta."""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(timeout)
            result = sock.connect_ex((self.target, port))
            sock.close()
            return result == 0
        except:
            return False
    
    def scan_ports(self, ports: List[int] = None) -> List[ScanResult]:
        """Escaneia mÃºltiplas portas."""
        ports = ports or COMMON_PORTS
        console.print(f"\n[cyan]ğŸ” Escaneando {len(ports)} portas em {self.target}...[/cyan]")
        
        open_ports = []
        
        with Progress() as progress:
            task = progress.add_task("Scanning...", total=len(ports))
            
            with ThreadPoolExecutor(max_workers=50) as executor:
                futures = {executor.submit(self.port_scan, port): port for port in ports}
                
                for future in futures:
                    port = futures[future]
                    progress.advance(task)
                    
                    if future.result():
                        service = SERVICE_MAP.get(port, "Unknown")
                        result = ScanResult(
                            port=port,
                            state="open",
                            service=service
                        )
                        open_ports.append(result)
                        self.results.append(result)
        
        return open_ports
    
    def banner_grab(self, port: int) -> str:
        """ObtÃ©m banner do serviÃ§o."""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(2)
            sock.connect((self.target, port))
            sock.send(b"HEAD / HTTP/1.0\r\n\r\n")
            banner = sock.recv(1024).decode("utf-8", errors="ignore")
            sock.close()
            return banner[:100]
        except:
            return ""
    
    def enumerate_services(self):
        """Enumera serviÃ§os nas portas abertas."""
        console.print("\n[cyan]ğŸ” Enumerando serviÃ§os...[/cyan]")
        
        for result in self.results:
            banner = self.banner_grab(result.port)
            if banner:
                result.version = banner.split("\n")[0][:50]
    
    def check_common_vulns(self):
        """Verifica vulnerabilidades comuns."""
        console.print("\n[cyan]ğŸ” Verificando vulnerabilidades conhecidas...[/cyan]")
        
        for result in self.results:
            result.vulnerabilities = []
            
            if result.port == 21:  # FTP
                result.vulnerabilities.append("Check for anonymous login")
            elif result.port == 22:  # SSH
                result.vulnerabilities.append("Check for weak credentials")
                result.vulnerabilities.append("Check SSH version for CVEs")
            elif result.port == 23:  # Telnet
                result.vulnerabilities.append("Telnet transmits in cleartext!")
            elif result.port == 80 or result.port == 443:  # HTTP/HTTPS
                result.vulnerabilities.append("Run web vulnerability scanner")
            elif result.port == 445:  # SMB
                result.vulnerabilities.append("Check for EternalBlue (MS17-010)")
                result.vulnerabilities.append("Check for anonymous access")
            elif result.port == 3389:  # RDP
                result.vulnerabilities.append("Check for BlueKeep (CVE-2019-0708)")
    
    def run_full_scan(self):
        """Executa scan completo."""
        console.print(f"\n[bold cyan]ğŸ› ï¸ Pentest Suite - Target: {self.target}[/bold cyan]")
        
        self.scan_ports()
        self.enumerate_services()
        self.check_common_vulns()
        
        return self.results
    
    def print_results(self):
        """Imprime resultados."""
        if not self.results:
            console.print("\n[yellow]Nenhuma porta aberta encontrada[/yellow]")
            return
        
        table = Table(title=f"\nğŸ“Š Resultados - {self.target}")
        table.add_column("Porta", style="cyan")
        table.add_column("Estado")
        table.add_column("ServiÃ§o")
        table.add_column("VersÃ£o")
        table.add_column("Vulnerabilidades")
        
        for r in sorted(self.results, key=lambda x: x.port):
            vulns = "\n".join(r.vulnerabilities[:2]) if r.vulnerabilities else "-"
            table.add_row(
                str(r.port),
                f"[green]{r.state}[/green]",
                r.service,
                r.version[:30] if r.version else "-",
                vulns
            )
        
        console.print(table)
        console.print(f"\n[green]âœ… {len(self.results)} portas abertas encontradas[/green]")


def main():
    parser = argparse.ArgumentParser(description="Penetration Testing Suite")
    parser.add_argument("--target", "-t", required=True, help="Target IP/hostname")
    parser.add_argument("--ports", "-p", help="Portas especÃ­ficas (ex: 80,443,8080)")
    parser.add_argument("--full", action="store_true", help="Scan completo")
    
    args = parser.parse_args()
    
    suite = PentestSuite(args.target)
    
    if args.ports:
        ports = [int(p) for p in args.ports.split(",")]
        suite.scan_ports(ports)
    else:
        suite.run_full_scan()
    
    suite.print_results()


if __name__ == "__main__":
    main()
